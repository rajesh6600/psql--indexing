<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product Filter Dashboard</title>
  <style>
    /*   keep your existing styles */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f6f8;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
    }
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    .filters-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }
    .filter-group {
      background: #ffffff;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .columns-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    .results-section {
      margin-top: 30px;
      background: #fff;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    th {
      background: #f0f0f0;
    }
    .pagination {
      margin-top: 16px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Product Filter Dashboard</h1>
      <p>Advanced filtering and column selection for product data</p>
    </div>

    <div class="filters-section">
      <form id="filterForm">
        <div class="filters-grid">
          <div class="filter-group">
            <h3>Weight (g)</h3>
            <div class="filter-controls">
              <div class="filter-row">
                <label>Enable:</label>
                <select id="weight_enabled">
                  <option value="false">Disabled</option>
                  <option value="true">Enabled</option>
                </select>
              </div>
              <div class="filter-row" id="weight_range" style="display: none;">
                <label>Range:</label>
                <div class="range-inputs">
                  <input type="number" id="weight_min" placeholder="Min" step="1" />
                  <span>to</span>
                  <input type="number" id="weight_max" placeholder="Max" step="1" />
                </div>
              </div>
            </div>
          </div>

          <div class="filter-group">
            <h3>Length (cm)</h3>
            <div class="filter-controls">
              <div class="filter-row">
                <label>Enable:</label>
                <select id="length_enabled">
                  <option value="false">Disabled</option>
                  <option value="true">Enabled</option>
                </select>
              </div>
              <div class="filter-row" id="length_range" style="display: none;">
                <label>Range:</label>
                <div class="range-inputs">
                  <input type="number" id="length_min" placeholder="Min" step="1" />
                  <span>to</span>
                  <input type="number" id="length_max" placeholder="Max" step="1" />
                </div>
              </div>
            </div>
          </div>

          <div class="filter-group">
            <h3>Width (cm)</h3>
            <div class="filter-controls">
              <div class="filter-row">
                <label>Enable:</label>
                <select id="width_enabled">
                  <option value="false">Disabled</option>
                  <option value="true">Enabled</option>
                </select>
              </div>
              <div class="filter-row" id="width_range" style="display: none;">
                <label>Range:</label>
                <div class="range-inputs">
                  <input type="number" id="width_min" placeholder="Min" step="1" />
                  <span>to</span>
                  <input type="number" id="width_max" placeholder="Max" step="1" />
                </div>
              </div>
            </div>
          </div>

          <div class="filter-group">
            <h3>Height (cm)</h3>
            <div class="filter-controls">
              <div class="filter-row">
                <label>Enable:</label>
                <select id="height_enabled">
                  <option value="false">Disabled</option>
                  <option value="true">Enabled</option>
                </select>
              </div>
              <div class="filter-row" id="height_range" style="display: none;">
                <label>Range:</label>
                <div class="range-inputs">
                  <input type="number" id="height_min" placeholder="Min" step="1" />
                  <span>to</span>
                  <input type="number" id="height_max" placeholder="Max" step="1" />
                </div>
              </div>
            </div>
          </div>

          <div class="filter-group">
            <h3>Photos Quantity</h3>
            <div class="filter-controls">
              <div class="filter-row">
                <label>Enable:</label>
                <select id="photos_enabled">
                  <option value="false">Disabled</option>
                  <option value="true">Enabled</option>
                </select>
              </div>
              <div class="filter-row" id="photos_range" style="display: none;">
                <label>Range:</label>
                <div class="range-inputs">
                  <input type="number" id="photos_min" placeholder="Min" step="1" />
                  <span>to</span>
                  <input type="number" id="photos_max" placeholder="Max" step="1" />
                </div>
              </div>
            </div>
          </div>

          
        </div>
        <!--   Columns -->
        <div class="columns-section">
          <h3>Select Columns to Display</h3>
          <div class="columns-grid">
            <label><input type="checkbox" id="col_category" value="product_category_name" /> Category</label>
            <label><input type="checkbox" id="col_weight" value="product_weight_g" /> Weight</label>
            <label><input type="checkbox" id="col_length" value="product_length_cm" /> Length</label>
            <label><input type="checkbox" id="col_width" value="product_width_cm" /> Width</label>
            <label><input type="checkbox" id="col_height" value="product_height_cm" /> Height</label>
            <label><input type="checkbox" id="col_photos" value="product_photos_qty" /> Photos Qty</label>

          </div>
        </div>

        <div class="submit-section">
          <button type="submit" class="submit-btn">Apply Filters & Load Results</button>
        </div>
      </form>
    </div>

    <!--   Results -->
    <div class="results-section">
      <div class="results-header">
        <h2>Filtered Products</h2>
        <div class="results-count" id="resultsCount">No results yet</div>
      </div>
      <div id="resultsContainer"></div>

      <!--   Pagination OUTSIDE resultsContainer -->
      <!-- <div class="pagination">
        <button id="prevPage">Prev</button>
        <span id="pageInfo"></span>
        <button id="nextPage">Next</button>
      </div> -->
    </div>
  </div>

  <!--   Script now outside resultsContainer -->
  <script>
    let page = 1;
    let limit = 50; // load smaller chunks for smoother scrolling
    let totalPages = 1;
    let totalCount = 0;
    let isLoading = false; // prevent duplicate fetches

    

    const filterFields = {
      'weight': 'product_weight_g',
      'length': 'product_length_cm',
      'width': 'product_width_cm',
      'height': 'product_height_cm',
      'photos': 'product_photos_qty',
      'description': 'product_description_length'
    };

    const columnFields = {
      'product_category_name': 'Category Name',
      'product_weight_g': 'Weight (g)',
      'product_length_cm': 'Length (cm)',
      'product_width_cm': 'Width (cm)',
      'product_height_cm': 'Height (cm)',
      'product_photos_qty': 'Photos Qty',
      'product_description_length': 'Description Length',
      'product_name_length': 'Name Length'
    };

    function initializeFilterToggles() {
      Object.keys(filterFields).forEach(filterName => {
        const enabledSelect = document.getElementById(`${filterName}_enabled`);
        const rangeDiv = document.getElementById(`${filterName}_range`);
        if (!enabledSelect) return;
        enabledSelect.addEventListener('change', () => {
          if (enabledSelect.value === 'true') {
            rangeDiv.style.display = 'block';
          } else {
            rangeDiv.style.display = 'none';
          }
        });
      });
    }

    function buildQueryParams() {
      const params = new URLSearchParams();
      Object.keys(filterFields).forEach(filterName => {
        const enabledSelect = document.getElementById(`${filterName}_enabled`);
        if (enabledSelect && enabledSelect.value === 'true') {
          const min = document.getElementById(`${filterName}_min`)?.value;
          const max = document.getElementById(`${filterName}_max`)?.value;
          if (min && max) {
            params.append('filters', `${filterFields[filterName]}:${min}:${max}`);
          }
        }
      });
      const selectedColumns = [];
      document.querySelectorAll('.column-checkbox input:checked, input[type="checkbox"]:checked').forEach(cb => {
        selectedColumns.push(cb.value);
      });
      if (selectedColumns.length > 0) {
        params.append('columns', selectedColumns.join(','));
      }
      params.append('page', page);
      params.append('limit', limit);
      return params;
    }

    // function displayResults(data, selectedColumns) 
    //   Instead of replacing, append rows
    function appendResults(data, selectedColumns, reset = false) {
      const container = document.getElementById('resultsContainer');
      const countElement = document.getElementById('resultsCount');

      if (reset) {
        container.innerHTML = '';
      }

      if (data.length === 0) {
        container.innerHTML = '<p>No results found</p>';
        countElement.textContent = '0 results';
        return;
      }

      countElement.textContent = `${totalCount} total results`;
      
  let table = container.querySelector('table');
  if (!table) {
    // create table once
    let html = '<table><thead><tr>';
    selectedColumns.forEach(col => {
      html += `<th>${columnFields[col] || col}</th>`;
    });
    html += '</tr></thead><tbody></tbody></table>';
    container.innerHTML = html;
    table = container.querySelector('table');
  }

  const tbody = table.querySelector('tbody');
  data.forEach(row => {
    let tr = '<tr>';
    selectedColumns.forEach(col => {
      tr += `<td>${row[col] ?? 'N/A'}</td>`;
    });
    tr += '</tr>';
    tbody.insertAdjacentHTML('beforeend', tr);
  });
}

    function fetchProducts(reset = false) {
      if (isLoading) return;
      isLoading = true;

      const params = buildQueryParams();
      const url = `/products?${params.toString()}`;

      fetch(url)
        .then(res => res.json())
        .then(response => {
          const data = response.data;
          totalCount = response.totalCount;
          totalPages = Math.ceil(totalCount / limit);
          const cols = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
          appendResults(data, cols, reset);
          isLoading = false;
        })
        .catch(err => {
          console.error(err);
          isLoading = false;
        });
    }

    //   Infinite scroll listener
    window.addEventListener('scroll', () => {
      if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200) {
        if (page < totalPages && !isLoading) {
          page++;
          fetchProducts();
        }
      }
});

    //   Filter form resets and reloads from page 1
    document.getElementById('filterForm').addEventListener('submit', e => {
      e.preventDefault();
      page = 1;
      fetchProducts(true); // reset = true clears old results
    });

      document.addEventListener('DOMContentLoaded', () => {
      initializeFilterToggles();
      document.getElementById('col_category').checked = true;
      document.getElementById('col_weight').checked = true;
      fetchProducts(true); // initial load
});



    //   let html = '<table><thead><tr>';
    //   selectedColumns.forEach(col => {
    //     html += `<th>${columnFields[col] || col}</th>`;
    //   });
    //   html += '</tr></thead><tbody>';
    //   data.forEach(row => {
    //     html += '<tr>';
    //     selectedColumns.forEach(col => {
    //       html += `<td>${row[col] ?? 'N/A'}</td>`;
    //     });
    //     html += '</tr>';
    //   });
    //   html += '</tbody></table>';
    //   container.innerHTML = html;

    //   document.getElementById('pageInfo').textContent = `Page ${page} of ${totalPages}`;
    // }

    // function fetchProducts() {
    //   const params = buildQueryParams();
    //   const url = `/products?${params.toString()}`;
    //   document.getElementById('resultsContainer').innerHTML = '<p>Loading...</p>';
    //   fetch(url)
    //     .then(res => res.json())
    //     .then(response => {
    //       const data = response.data;
    //       totalCount = response.totalCount;
    //       totalPages = Math.ceil(totalCount / limit);
    //       const cols = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
    //       displayResults(data, cols);
    //     })
    //     .catch(err => {
    //       console.error(err);
    //       document.getElementById('resultsContainer').innerHTML = '<p>Error loading data</p>';
    //       document.getElementById('resultsCount').textContent = 'Error';
    //     });
    // }

    // document.getElementById('filterForm').addEventListener('submit', e => {
    //   e.preventDefault();
    //   page = 1;
    //   fetchProducts();
    // });

    // document.getElementById('prevPage').addEventListener('click', () => {
    //   if (page > 1) {
    //     page--;
    //     fetchProducts();
    //   }
    // });
    // document.getElementById('nextPage').addEventListener('click', () => {
    //   if (page < totalPages) {
    //     page++;
    //     fetchProducts();
    //   }
    // });

    // document.addEventListener('DOMContentLoaded', () => {
    //   initializeFilterToggles();
    //   document.getElementById('col_category').checked = true;
    //   document.getElementById('col_weight').checked = true;
    //   fetchProducts();
    // });
  </script>
</body>
</html>
